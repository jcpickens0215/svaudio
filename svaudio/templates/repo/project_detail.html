{% extends "base.html" %}
{% load claims static compress %}

{% block title %}Project: {{ object.name }}{% endblock %}

{% block nav_active_projects %}active{% endblock %}

{% block content %}
  <h1>Project: {{ object.name }}</h1>

  {% approved_claims_for_object object as claims %}

  {% include "repo/_byline.html" %}

  <p>
    {% include "_fragments/_tag_links.html" with modelname="project" object=object %}
  </p>

  <div>
    {% include "repo/_add_tag_inline_form.html" with add_tag_url_name="repo:project-add-tag" %}
  </div>

  <hr>

  <h2>SunVox web player</h2>

  <p>
    <button onclick="playProject()">Play</button>
    <button onclick="stopProject()">Stop</button>
    <span id="status"></span>
  </p>

  <hr>

  {% include "repo/_file_details.html" %}

  <hr>

  {% include "repo/_found_at.html" with type="project" %}

  {% include "repo/_ownership.html" with type="project" %}

{% endblock content %}

{% block javascript %}
  {{ block.super }}
  <script src="{% static "js/sunvox/sunvox.js" %}"></script>
  <script src="{% static "js/sunvox/sunvox_lib_loader.js" %}"></script>
{% endblock %}

{% block inline_javascript %}
  <script type="application/javascript">
    let loading = false
    let loaded = false
    svlib.then(function (Module) {
      svlib = Module
      sv_init(0, 44100, 2, 0)
    })
    function setStatus(status) {
      document.getElementById("status").innerHTML = status
      console.log(status)
    }
    function playProject() {
      if (loading) {
        return
      }
      if (loaded) {
        setStatus("Playing")
        sv_play_from_beginning(0)
      }
      if (!loaded) {
        loading = true
        setStatus("Loading...")
        let req = new XMLHttpRequest();
        req.open("GET", "{{ object.file.media_url }}", true);
        req.responseType = "arraybuffer";
        req.onload = function (e) {
          if (this.status !== 200) {
            return
          }
          let arrayBuffer = this.response
          if (arrayBuffer) {
            let byteArray = new Uint8Array(arrayBuffer)
            sv_open_slot(0)
            if (sv_load_from_memory(0, byteArray) === 0) {
              setStatus("Playing")
              loaded = true
              loading = false
              sv_play_from_beginning(0)
            }
          }
        }
        req.send(null)
      }
    }
    function stopProject() {
      setStatus("Stopped")
      sv_stop(0)
    }
  </script>
{% endblock %}
